{% extends "base.html" %}
{% block title %}Admin Dashboard - QGig{% endblock %}
{% block content %}
<div class="container" style="max-width: 1400px; padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; font-weight: 700;">
            <i class="fas fa-shield-alt"></i> Admin Control Panel
        </h1>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('web.admin_users') }}" class="btn btn-outline">
                <i class="fas fa-users"></i> Manage Users
            </a>
            <a href="{{ url_for('web.admin_documents') }}" class="btn btn-outline">
                <i class="fas fa-file-alt"></i> Verify Documents
            </a>
            <a href="{{ url_for('web.admin_payments') }}" class="btn btn-outline">
                <i class="fas fa-money-bill-wave"></i> View Payments
            </a>
        </div>
    </div>

    <!-- Analytics Summary -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
            <div class="card-body">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Users</div>
                <div style="font-size: 2rem; font-weight: 700;">{{ analytics.users.total }}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">
                    {{ analytics.users.professionals }} Professionals | {{ analytics.users.institutions }} Institutions
                </div>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none;">
            <div class="card-body">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Revenue</div>
                <div style="font-size: 2rem; font-weight: 700;">${{ "{:,.0f}".format(analytics.payments.total_revenue) }}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">
                    {{ analytics.payments.completed }} completed payments
                </div>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none;">
            <div class="card-body">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Gigs</div>
                <div style="font-size: 2rem; font-weight: 700;">{{ analytics.gigs.total }}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">
                    {{ analytics.gigs.completed }} completed | {{ analytics.gigs.open }} open
                </div>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border: none;">
            <div class="card-body">
                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Pending Documents</div>
                <div style="font-size: 2rem; font-weight: 700;">{{ analytics.documents.pending }}</div>
                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">
                    {{ analytics.documents.approved }} approved | {{ analytics.documents.rejected }} rejected
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 2rem;">
        <div style="display: flex; gap: 2rem;">
            <button class="tab-btn active" data-tab="users" style="padding: 1rem 0; border: none; background: none; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                <i class="fas fa-users"></i> Users ({{ analytics.users.total }})
            </button>
            <button class="tab-btn" data-tab="documents" style="padding: 1rem 0; border: none; background: none; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                <i class="fas fa-file-alt"></i> Documents ({{ analytics.documents.pending }})
            </button>
            <button class="tab-btn" data-tab="payments" style="padding: 1rem 0; border: none; background: none; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                <i class="fas fa-money-bill-wave"></i> Payments ({{ analytics.payments.total }})
            </button>
            <button class="tab-btn" data-tab="analytics" style="padding: 1rem 0; border: none; background: none; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s;">
                <i class="fas fa-chart-line"></i> Analytics
            </button>
        </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-content" id="users-tab">
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title">User Management</h3>
                <input type="text" id="userSearch" placeholder="Search users..." style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px; width: 300px;">
            </div>
            <div class="card-body" style="padding: 0;">
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for u in users %}
                        <tr>
                            <td>{{ u.email }}</td>
                            <td><span class="badge-status">{{ u.role.value|upper }}</span></td>
                            <td>
                                <span class="badge-status badge-{% if u.is_active %}active{% else %}inactive{% endif %}">
                                    {% if u.is_active %}Active{% else %}Inactive{% endif %}
                                </span>
                            </td>
                            <td>{{ u.created_at.strftime('%b %d, %Y') if u.created_at else '' }}</td>
                            <td>
                                {% if u.role.value != 'admin' %}
                                <button type="button" class="btn btn-sm {% if u.is_active %}btn-outline{% else %}btn-primary{% endif %} admin-toggle-user" data-user-id="{{ u.id }}" data-is-active="{{ 1 if u.is_active else 0 }}">
                                    {% if u.is_active %}Suspend{% else %}Activate{% endif %}
                                </button>
                                {% else %}
                                <span style="color: #6b7280;">Admin</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" style="text-align: center; padding: 2rem; color: #6b7280;">No users found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-content" id="documents-tab" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Document Verification</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Document Type</th>
                            <th>File Name</th>
                            <th>Uploaded</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsTableBody">
                        {% for d in documents %}
                        <tr>
                            <td>{{ d.user.email if d.user else ('User #' ~ d.user_id) }}</td>
                            <td>{{ d.document_type.value|upper if d.document_type else '' }}</td>
                            <td>{{ d.file_path.split('/')[-1] if d.file_path else '' }}</td>
                            <td>{{ d.uploaded_at.strftime('%b %d, %Y') if d.uploaded_at else '' }}</td>
                            <td><span class="badge-status badge-{{ d.status.value if d.status else 'pending' }}">{{ (d.status.value if d.status else 'pending')|upper }}</span></td>
                            <td>
                                {% if d.status and d.status.value == 'pending' %}
                                <form method="POST" action="{{ url_for('web.approve_document', document_id=d.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-sm btn-primary" onclick="return confirm('Approve this document?')">Approve</button>
                                </form>
                                <form method="POST" action="{{ url_for('web.reject_document', document_id=d.id) }}" style="display: inline;">
                                    <input type="hidden" name="reason" value="Document did not meet verification requirements">
                                    <button type="submit" class="btn btn-sm btn-outline" onclick="return confirm('Reject this document?')">Reject</button>
                                </form>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No documents found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payments Tab -->
    <div class="tab-content" id="payments-tab" style="display: none;">
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title">Payment Oversight</h3>
                <select id="paymentStatusFilter" style="padding: 0.5rem 1rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <option value="">All Statuses</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
            <div class="card-body" style="padding: 0;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Payment ID</th>
                            <th>Institution</th>
                            <th>Professional</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody">
                        {% for p in payments %}
                        <tr data-status="{{ p.status.value if p.status else '' }}">
                            <td>#{{ p.id }}</td>
                            <td>{{ p.institution.institution_name if p.institution else ('Institution #' ~ p.institution_id) }}</td>
                            <td>{{ p.professional.full_name if p.professional else ('Professional #' ~ p.professional_id) }}</td>
                            <td>UGX {{ "{:,.0f}".format(p.amount) }}</td>
                            <td><span class="badge-status badge-{{ p.status.value if p.status else 'pending' }}">{{ (p.status.value if p.status else 'pending')|upper }}</span></td>
                            <td>{{ p.created_at.strftime('%b %d, %Y') if p.created_at else '' }}</td>
                        </tr>
                        {% else %}
                        <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">No payments found</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Top Institutions</h3>
                </div>
                <div class="card-body">
                    {% if analytics.top_institutions %}
                        {% for inst in analytics.top_institutions %}
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                            <span>{{ inst.name or 'Institution #' + inst.id|string }}</span>
                            <span style="font-weight: 600; color: #3b82f6;">{{ inst.gig_count }} gigs</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: #6b7280; padding: 2rem;">No data available</p>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Top Professionals</h3>
                </div>
                <div class="card-body">
                    {% if analytics.top_professionals %}
                        {% for prof in analytics.top_professionals %}
                        <div style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f3f4f6;">
                            <span>{{ prof.name or 'Professional #' + prof.id|string }}</span>
                            <span style="font-weight: 600; color: #10b981;">{{ prof.hire_count }} hires</span>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p style="text-align: center; color: #6b7280; padding: 2rem;">No data available</p>
                    {% endif %}
                </div>
            </div>

            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h3 class="card-title">Revenue Trend (Last 30 Days)</h3>
                </div>
                <div class="card-body">
                    <div id="revenueChart" style="height: 300px; display: flex; align-items: flex-end; justify-content: space-around; gap: 0.5rem;">
                        {% if analytics.daily_revenue %}
                            {% for day in analytics.daily_revenue %}
                            <div class="revenue-bar" data-height="{% if analytics.payments.total_revenue %}{{ (day.revenue / analytics.payments.total_revenue * 100)|int }}{% else %}0{% endif %}" style="flex: 1; background: linear-gradient(to top, #3b82f6, #60a5fa); border-radius: 4px 4px 0 0; min-height: 20px; height: 0%; position: relative;" title="{{ day.date }}: ${{ day.revenue }}">
                                <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 0.65rem; color: #6b7280; white-space: nowrap;">{{ day.date[-5:] }}</div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p style="text-align: center; color: #6b7280; padding: 2rem; width: 100%;">No revenue data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tab-btn.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
}

.tab-btn:hover {
    color: #1e40af;
}

.badge-status {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-completed { background: #d1fae5; color: #065f46; }
.badge-pending { background: #fef3c7; color: #92400e; }
.badge-failed { background: #fee2e2; color: #991b1b; }
.badge-active { background: #dbeafe; color: #1e40af; }
.badge-inactive { background: #f3f4f6; color: #6b7280; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            
            this.classList.add('active');
            document.getElementById(this.dataset.tab + '-tab').style.display = 'block';
        });
    });

    // Payment filter (client-side filter on server-rendered rows)
    const filterEl = document.getElementById('paymentStatusFilter');
    if (filterEl) {
        filterEl.addEventListener('change', function() {
            const status = (this.value || '').toLowerCase();
            document.querySelectorAll('#paymentsTableBody tr[data-status]').forEach(row => {
                const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
                row.style.display = (!status || rowStatus === status) ? '' : 'none';
            });
        });
    }

    // User search
    document.getElementById('userSearch').addEventListener('input', function() {
        const search = this.value.toLowerCase();
        document.querySelectorAll('#usersTableBody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    });

    // Revenue chart bars
    document.querySelectorAll('.revenue-bar').forEach(bar => {
        const pct = parseInt(bar.getAttribute('data-height') || '0', 10);
        bar.style.height = `${Math.max(0, Math.min(100, pct))}%`;
    });

    // User status toggles
    document.querySelectorAll('.admin-toggle-user').forEach(btn => {
        btn.addEventListener('click', () => {
            const userId = parseInt(btn.getAttribute('data-user-id') || '0', 10);
            const isActive = parseInt(btn.getAttribute('data-is-active') || '0', 10);
            if (userId) toggleUserStatus(userId, isActive);
        });
    });
});

async function toggleUserStatus(userId, isActive) {
    const action = isActive ? 'suspend' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;

    try {
        const response = await fetch(`/admin/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });

        const data = await response.json();
        if (response.ok && data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update user status'));
        }
    } catch (error) {
        console.error('Error toggling user status:', error);
        alert('An error occurred while updating user status.');
    }
}
</script>
{% endblock %}
